services:
  d4bl-api:
    build: .
    container_name: d4bl-api
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app/src
      # Use host.docker.internal to access Ollama running on the host machine
      # On Linux, you may need to use the host's IP address instead
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      # Database configuration
      # Supabase CLI defaults to localhost:54322 with postgres/postgres credentials
      # Ensure `supabase start` is running on the host before `docker compose up`
      - POSTGRES_HOST=${POSTGRES_HOST:-host.docker.internal}
      - POSTGRES_PORT=${POSTGRES_PORT:-54322}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
      # Embedder configuration for CrewAI memory
      - EMBEDDINGS_OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - EMBEDDINGS_OLLAMA_MODEL_NAME=mxbai-embed-large
      # Client-side request throttling (for documentation - actual throttling happens on Ollama server)
      # Configure Ollama server-side queue via environment variables when starting Ollama:
      # - OLLAMA_MAX_QUEUE: Max queued requests (default: 512)
      # - OLLAMA_NUM_PARALLEL: Max parallel requests per model (default: auto)
      # - OLLAMA_MAX_LOADED_MODELS: Max models loaded concurrently (default: 3x GPUs or 3)
      # Phoenix by Arize AI configuration for observability
      # Phoenix runs as a Docker service, accessible via service name "phoenix"
      - PHOENIX_PROJECT_NAME=${PHOENIX_PROJECT_NAME:-d4bl-crewai}
      # When Phoenix authentication is enabled, the client libraries and OTEL exporters
      # use PHOENIX_API_KEY / PHOENIX_ENDPOINT for auth and routing.
      # After you create a System API key in the Phoenix UI, set PHOENIX_API_KEY in
      # your .env file so this service can continue sending traces.
      - PHOENIX_ENDPOINT=${PHOENIX_ENDPOINT:-http://phoenix:6006}
      - PHOENIX_API_KEY=${PHOENIX_API_KEY:-}
    env_file:
      - .env
    volumes:
      - ./output:/app/output
      - ./.env:/app/.env:ro
    depends_on:
      phoenix:
        condition: service_started
    restart: unless-stopped
    networks:
      - d4bl-network
    extra_hosts:
      # Add host.docker.internal for Linux compatibility
      - "host.docker.internal:host-gateway"

  d4bl-frontend:
    build:
      context: ./ui-nextjs
      dockerfile: Dockerfile
      args:
        # Pass NEXT_PUBLIC_API_URL at build time so it's embedded in the client bundle
        NEXT_PUBLIC_API_URL: http://localhost:8000
    container_name: d4bl-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      # For client-side connections (browser), use the exposed port
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      # For server-side rendering in Docker, use the internal service name
      - API_INTERNAL_URL=http://d4bl-api:8000
    depends_on:
      - d4bl-api
    restart: unless-stopped
    networks:
      - d4bl-network

  # Ollama service removed - using Ollama running on the host machine
  # Make sure Ollama is running on your host: ollama serve
  # And pull the Mistral model: ollama pull mistral

  # Phoenix by Arize AI for observability
  # Reference: https://arize.com/docs/phoenix/self-hosting/deployment-options/docker
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: phoenix
    environment: {}
      # --- Authentication options (see docs) ---
      # Docs: https://arize.com/docs/phoenix/self-hosting/features/authentication
      #
      # Set PHOENIX_ENABLE_AUTH=true to require login & API keys.
      # WARNING: When enabling auth, all trace ingestion and API access
      # will be blocked until you create a System API key in the UI.
      # - PHOENIX_ENABLE_AUTH=${PHOENIX_ENABLE_AUTH:-true}
      #
      # PHOENIX_SECRET is required when auth is enabled. Override this in
      # your .env file with a long, random value and keep it secret.
      # - PHOENIX_SECRET=${PHOENIX_SECRET:-change-me-32chars-min1digit1lower}
      #
      # Optional: set an initial admin password on first startup.
      # Default admin user: admin@localhost
      # - PHOENIX_DEFAULT_ADMIN_INITIAL_PASSWORD=${PHOENIX_DEFAULT_ADMIN_INITIAL_PASSWORD:-admin}
      #
      # Optional: use secure cookies when serving Phoenix over HTTPS.
      # - PHOENIX_USE_SECURE_COOKIES=${PHOENIX_USE_SECURE_COOKIES:-false}
      #
      # Optional: root URL if you front Phoenix with a reverse proxy.
      # - PHOENIX_ROOT_URL=${PHOENIX_ROOT_URL:-https://example.com/phoenix}
    ports:
      - "6006:6006"  # UI and OTLP HTTP collector
      - "4317:4317"  # OTLP gRPC collector
    restart: unless-stopped
    networks:
      - d4bl-network

networks:
  d4bl-network:
    driver: bridge

